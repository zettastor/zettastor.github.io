---
title: KVM (基于内核的虚拟机)
description: Docs intro
layout: ~/layouts/DocLayout.astro
---

在 KVM 虚拟服务器上部署 ZettaStor DBS 比在物理服务器上部署有很多优势，尤其是在 RAM 和 CPU 等资源的使用方面。KVM 属于1类（裸机）虚拟机管理程序，可以进一步提升 DBS 的性能和可扩展性。随着超融合基础设施（HCI）概念的加入，计算、存储和网络资源被组合到一个软件定义的基础设施中，作为一个实体进行管理，从而实现高效的资源分配，并可以在虚拟机之间提供高级别的隔离。

## 在 KVM 上部署的优势

1. 资源效率：KVM 虚拟化允许多个虚拟机在单个物理服务器上运行。 这意味着可以在多个虚拟机之间共享相同的资源（例如 RAM 和 CPU），从而充分利用硬件。 而对于物理服务器，每个服务器都需要自己的专用资源。在 KVM 上部署当前版本的 DBS 软件需要 1 个虚拟 CPU 核心和 128 GB RAM。 

2. 可扩展性：KVM 虚拟化在按需扩展或缩减资源方面可以提供更大的灵活性。例如，如果 DBS 需要更多 RAM，经由 HCI 可以轻松将其分配到虚拟机中，而无需购买新硬件。 对于物理服务器，添加更多 RAM 必须在物理上安装额外的内存模块。

3. 节省成本：在 KVM 上运行虚拟机与运行多台物理服务器相比可以节省大量资金。 虚拟化消除了对物理硬件的需求，并降低了与硬件维护、功耗和冷却相关的成本。

4. 易于管理：KVM 虚拟化提供了一个集中管理界面，可以轻松地从一个位置管理和监控多个虚拟机。 这消除了物理访问每个服务器以执行管理任务的需要。

总之，在 KVM 上部署 DBS 与物理服务器相比具有多项优势，包括更好的资源分配、灵活性和可扩展性。

## KVM 配置

检查当前节点是否已经安装所需要的软件以及其它需要的配置。

（如果没有安装的话，会调用自动化部署中准备部署环境的脚本来进行所需要软件的安装）

执行 `bash prepare_deploy_host.sh` 进行环境安装准备。

### 环境检查

这部分主要功能是检查物理机是否开启虚拟化支持，软件安装是否成功，网络配置是否正常。这里暂定采用串行的方式进行执行。

执行 `perl quantum_check_required_environment.pl`

这部分预留主要检查如下内容（这里暂定采用串行的方式进行执行）：

（目前这个脚本主要检查当前部署节点是否安装了所需要的软件包，并不涉及其它节点的检查。

下面这些检测有的是在其它脚本中进行的，并没有统一放到此脚本中）

  - 物理机是否开启虚拟化支持，

  - 部署安装所需要的基本软件安装是否成功，

  - 网络配置是否正常。

  - 宿主机物理CPU个数的检查，目前仅支持1颗和2颗物理CPU

### 软件安装

这部分主要是在宿主机上安装创建虚拟机所需要的软件。

这个部分操作使用 `quantum_server_config.xml` 文件中相关参数解释如下：


|  属性名称   |     取值说明     |
| ------------- |:-------------:|
| kvm-拷贝创建    |              |
| login.name     | 登录服务器节点的用户名，通常是root  |
| login.password | 登录服务器节点的用户名对应的密码     |
| kvm.host.range | 需要安装创建虚拟机所需要软件的宿主机范围 |

节点之间采用并行的方式，为了防止读操作对本地硬盘压力过大，限制并行的节点数量为4.

执行 `perl quantum_kvm_software_installation.pl`

### 安装创建

这部分主要是准备虚拟机的创建脚本或者创建命令，然后根据提示，执行脚本并完成虚拟机操作系统的安装。

修改 `quantum_server_config.xml` 文件中的相关部分参数。

执行 `perl quantum_kvm_creation.pl` 进行虚拟机的创建脚本或者命令准备。

（在执行之前，需要将ISO镜像文件放到部署节点的 `/opt/deploy` 目录下，并且该目录下只能有一个iso文件）

这个部分操作使用 `quantum_server_config.xml` 文件中相关参数解释如下：

|  属性名称   |     取值说明     |
| ------------- |:-------------:|
| login.name             | 登录服务器节点的用户名，通常是root                                                                                                         |
| login.password         | 登录服务器节点的用户名对应的密码                                                                                                            |
| kvm.host.range         | 需要创建的虚拟机的宿主机范围                                                                                                              |
| kvm.host.name.interval | 虚拟机名称与宿主机ip地址最后一个字段的数值间隔。比如宿主机的ip地址为192.168.12.34， 间隔为20，虚拟机的名称为计算方法为34+20=54，固定为3位整数就是054，加上虚拟机名称前缀vm。在此宿主机上创建的虚拟机名称为vm054 |
| kvm.location.path      | 创建的虚拟机系统盘文件存放位置，取值为“default”表示为默认位置“/var/lib/libvirt/images”                                                                |
| kvm.system.size.gb     | 虚拟机的系统盘大小，单位为GB                                                                                                             |
| kvm.memory.size.gb     | 虚拟机的内存大小，单位为GB                                                                                                              |
| kvm.cpu.percentage     | 单个虚拟机占用的CPU资源占宿主机CPU资源的比例。这里的比例是以单颗物理CPU为基准计算的。取值范围在\[5,80\]之间。                                                             |
| kvm.bridge.base.name   | 虚拟机可以使用的基础网桥信息。宿主机上必须要存在对应的网桥设备。                                                                                            |
| kvm.prefix.string      | 虚拟机的名称前缀                                                                                                                    |
|                        |                                                                                                                             |

脚本执行结束后，每个宿主机节点手动执行 `bash /tmp/create_kvm.sh` 进行虚拟机的创建工作。

### 资源配置

这部分主要功能是完成虚拟机资源的配置（包括CPU、内存、网卡、磁盘等）。VNC端口配置和开机自启动，以及其它一些配置和检查。这里暂定采用串行的方式进行执行。

执行 `perl quantum_kvm_configuration.pl` 完成虚拟机的配置。

这个部分操作使用 `quantum_server_config.xml` 文件中相关参数解释如下：

（有些配置参数与创建时使用的参数是共用的，需要读取创建时使用的信息来获取宿主机上虚拟机的名称等内容）

|  属性名称   |     取值说明     |
| ------------- |:-------------:|                                                                                                                            |
| login.name             | 登录服务器节点的用户名，通常是root                                                                                                         |
| login.password         | 登录服务器节点的用户名对应的密码                                                                                                            |
| kvm.host.range         | 需要创建的虚拟机的宿主机范围                                                                                                              |
| kvm.host.name.interval | 虚拟机名称与宿主机ip地址最后一个字段的数值间隔。比如宿主机的ip地址为192.168.12.34， 间隔为20，虚拟机的名称为计算方法为34+20=54，固定为3位整数就是054，加上虚拟机名称前缀vm。在此宿主机上创建的虚拟机名称为vm054 |
| kvm.memory.size.gb     | 虚拟机的内存大小，单位为GB                                                                                                              |
| kvm.cpu.percentage     | 单个虚拟机占用的CPU资源占宿主机CPU资源的比例。这里的比例是以单颗物理CPU为基准计算的。取值范围在\[5,80\]之间。                                                             |
| kvm.prefix.string      | 虚拟机的名称前缀                                                                                                                    |
| kvm.network.number     | 虚拟机规划配置的网络数量。                                                                                                               |
| kvm.bridge.index1.name | 虚拟机可以使用的网桥信息之一。宿主机上必须要存在对应的网桥设备。                                                                                            |
| kvm.bridge.index2.name | 虚拟机可以使用的网桥信息之一。宿主机上必须要存在对应的网桥设备。（跟配置的网络数量有关系）                                                                               |
|                        |                                                                                                                             |
|                        |                                                                                                                             |
